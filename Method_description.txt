R script used to process the haploid single cell replication timing (Dileep & Gilbert, 2018 Nat Communications). Sample raw read counts from Haploid H129-2 single cells and bulk replication timing data from F129-9 mouse ES cells are provided to test the pipeline.

##Read mapping##
Reads were demultiplexed based on their unique barcodes. Both cast/129 and H129-2 reads were mapped to mm10 mouse genome assembly using Bowtie 2 with default parameter settings. Reads with MAPQ score of above 10 were retained for further analysis. PCR duplicates were removed using rmdup tool in samtools. Mapped reads were binned into 50 kb windows. Homologue specific read mapping based on SNPs was done using a previously published pipeline21.

###Data correction and smoothing###
Single-cell sequencing data binned into 50 kb windows were used for the data correction and smoothing. Single cells with less than 250,000 reads were discarded and reads were then converted to read per million (RPM). Cells with complex karyotype aberrations or complete chromosome loss were discarded while cells with aneuploidy were corrected by normalizing to the mean read density of those chromosomes in the control G1 and G2 cells. Complex karyotype abnormalities which were found to occur in very few cells were identified by plotting the whole genome coverage at 1Mb bins.

G1 and G2 cells showed a relatively uniform coverage profile as expected and thus were used to account for GC bias, whole genome amplification bias and to discard regions with mappability issues. The mean of 5 G1 and cells and 1 G2 cell was calculated for all 50 kb bins. Bins with extreme values (mean RPM>99 percentile and mean RPM< 1 percentile) were identified and masked in all single cells. To identify repetitive segments of the genome with low mappability, we segmented the mean G1/G2 coverage using Piecewise Constant Fits (PCF) in R using package 'copynumber'31. The parameter used were gamma=3 and kmin=10. Segments with mean RPM lower than 5 percentile were discarded. Finally all single cells were divided by the mean G1/G2 coverage. 

Next each single-cell data was centered and scaled to have an equal inter-quartile range. Extreme values (mean RPM>99 percentile and mean RPM< 1 percentile) in each single-cell data was removed followed by median smoothing with a span of 15 windows.

###Data segmentation and Binarization###
The corrected smoothed data was segmented using PCF (R copynumber package) to identify segments with similar copynumber. The parameters used were gamma=3 and kmin=5. Next, the segmented data at 50 kb resolution was used to binarize the domains as replicated or un-replicated. Accurate binarization of the segmented data depends on choosing the correct threshold for each single cell separately. To this end, we used a brute-force strategy and applied 100 equally spaced thresholds spanning the distribution of the segmented data. At each step the segmented data was binarized and finally the best binary fit was chosen. 

The binary fit was calculated using manhattan distance between the binarized data and the un-binarized segmented data. Historically, 1 and 0 are used to denote binary data. However, in order to calculate the similarity based on manhattan distance, the binary values and the segmented data must have similar magnitude. To do this we first used mixture model fitting with 2 components (normalmixEM function in R package mixtools) to identify the replicated and un-replicated fractions in the segmented data. Then the binary values were set as the mean of the components. If the rare occasion when component means were very close (less than 0.7), the binary values were decided based on the skew of the segmented data. This happened predominantly when the cells were in very early or very late S-phase, because the fraction of replicated segments and un-replicated segments respectively were too low for the mixture model to identify as a distinct component. A positive skew (skew>0.2) indicated cells that are in early S-phase and the binary values were set to 50 percentile and 95 percentile of the segmented data. A negative skew (skew < -0.2) indicated cells that are in late S-phase and the binary values were set to 5 percentile and 50 percentile of the segmented data. Otherwise, the binary values were set to 25 percentile and 75 percentile of the segmented data. The binary signal with the minimum manhattan distance (highest similarity) from the segmented data was chosen as the best fit (Supplementary movie 1). Outlier bins with a segmented value outside of +/- 2 were not used for the threshold calculation. 67 cells had at least one outlier bin and the average amount of outlier bins was 0.1% of the genome.

####Removing outlier cells####
Outlier cells were defined as cells that don't correlate with any other cells after binarization. A heat map of genome-wide manhattan distance using binarized data for every pair-wise combination of haploid cell ordered by their rank in S-phase reveals cells that are ranked close together have the least distance and cells ranked far apart in S-phase have maximum distance. But some cells have low similarity to all the other cells and appear as streaks in the heat map (Supplementary Fig. 3). These cells were removed from further analysis. In total 19 outlier cells were removed from diploid data and 5 outlier cells were removed haploid data.

